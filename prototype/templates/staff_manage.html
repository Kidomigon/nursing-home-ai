<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Management â€” Room Companion</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="staff-layout">

    <!-- Header -->
    <header class="staff-header">
      <div>
        <h1>Staff Management</h1>
        <p class="subtitle">Create and manage staff accounts</p>
      </div>
      <div class="staff-identity">
        <span class="staff-name-badge">&#x1F464; {{ staff_name }}</span>
        <a href="/staff" class="back-link">Back to Dashboard</a>
        <a href="/staff/logout" class="logout-link">Sign out</a>
      </div>
    </header>

    <!-- Create Staff Button -->
    <div class="manage-toolbar">
      <button type="button" class="btn-action ack-btn create-staff-btn" onclick="openCreateModal()">+ Create Staff Account</button>
    </div>

    <!-- Staff Table -->
    <section class="staff-table-wrap">
      <table class="staff-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Display Name</th>
            <th>Role</th>
            <th>Last Login</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for s in staff_list %}
          <tr class="{% if not s.is_active %}inactive-row{% endif %}">
            <td class="mono-cell">{{ s.username }}</td>
            <td>{{ s.display_name }}</td>
            <td>
              <span class="role-badge role-{{ s.role }}">{{ s.role }}</span>
            </td>
            <td class="mono-cell">{{ s.last_login_at[:16] if s.last_login_at else 'Never' }}</td>
            <td>
              {% if s.is_active %}
              <span class="status-active">Active</span>
              {% else %}
              <span class="status-inactive">Inactive</span>
              {% endif %}
            </td>
            <td class="action-cell">
              {% if s.is_active %}
              <button type="button" class="btn-action" onclick="openEditModal({{ s.id }}, '{{ s.username }}', '{{ s.display_name }}', '{{ s.role }}')">Edit</button>
              <form method="post" action="/staff/manage/{{ s.id }}/deactivate" style="display:inline;" onsubmit="return confirm('Deactivate {{ s.display_name }}?');">
                <input type="hidden" name="csrf" value="{{ csrf_token }}" />
                <button type="submit" class="btn-action deactivate-btn">Deactivate</button>
              </form>
              {% else %}
              <span class="text-muted">Deactivated</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

  </div>

  <!-- Create Staff Modal -->
  <div id="create-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3>Create Staff Account</h3>
      <form method="post" action="/staff/manage/create">
        <input type="hidden" name="csrf" value="{{ csrf_token }}" />

        <label for="create-username">Username</label>
        <input type="text" id="create-username" name="username" required placeholder="e.g. sarah.jones" autocomplete="off" />

        <label for="create-display">Display Name</label>
        <input type="text" id="create-display" name="display_name" required placeholder="e.g. Nurse Sarah" />

        <label for="create-password">Password</label>
        <input type="password" id="create-password" name="password" required minlength="4" placeholder="Minimum 4 characters" />

        <label for="create-role">Role</label>
        <select id="create-role" name="role">
          <option value="nurse">Nurse</option>
          <option value="supervisor">Supervisor</option>
          <option value="admin">Admin</option>
        </select>

        <div class="modal-actions">
          <button type="button" class="btn-action" onclick="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn-action ack-btn">Create Account</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Staff Modal -->
  <div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3>Edit Staff Account</h3>
      <form id="edit-form" method="post">
        <input type="hidden" name="csrf" value="{{ csrf_token }}" />

        <label>Username</label>
        <input type="text" id="edit-username" disabled class="disabled-input" />

        <label for="edit-display">Display Name</label>
        <input type="text" id="edit-display" name="display_name" required />

        <label for="edit-role">Role</label>
        <select id="edit-role" name="role">
          <option value="nurse">Nurse</option>
          <option value="supervisor">Supervisor</option>
          <option value="admin">Admin</option>
        </select>

        <label for="edit-password">New Password <span class="optional-hint">(leave blank to keep current)</span></label>
        <input type="password" id="edit-password" name="password" placeholder="Leave blank to keep current" />

        <div class="modal-actions">
          <button type="button" class="btn-action" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn-action ack-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function openCreateModal() {
      document.getElementById('create-modal').style.display = 'flex';
      document.getElementById('create-username').focus();
    }

    function closeCreateModal() {
      document.getElementById('create-modal').style.display = 'none';
    }

    function openEditModal(id, username, displayName, role) {
      var form = document.getElementById('edit-form');
      form.action = '/staff/manage/' + id + '/edit';
      document.getElementById('edit-username').value = username;
      document.getElementById('edit-display').value = displayName;
      document.getElementById('edit-role').value = role;
      document.getElementById('edit-password').value = '';
      document.getElementById('edit-modal').style.display = 'flex';
      document.getElementById('edit-display').focus();
    }

    function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.style.display = 'none';
        }
      });
    });

    // Close modals on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(function(m) {
          m.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>
