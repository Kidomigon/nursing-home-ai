<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Portal — Room Companion</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta http-equiv="refresh" content="15" />
</head>
<body>
  <div class="staff-layout">

    <!-- Header with staff identity -->
    <header class="staff-header">
      <div>
        <h1>Staff Portal</h1>
        <p class="subtitle">Room Companion Alert Dashboard</p>
      </div>
      <div class="staff-identity">
        <span class="staff-name-badge">&#x1F464; {{ staff_name }}</span>
        {% if staff_role == 'admin' %}
        <a href="/staff/manage" class="manage-link">Manage Staff</a>
        {% endif %}
        <a href="/staff/logout" class="logout-link">Sign out</a>
      </div>
    </header>

    <!-- Room Status Cards -->
    <section class="room-cards">
      {% for rid, profile in profiles.items() %}
      <div class="room-card {% if room_latest_severity[rid] %}severity-{{ room_latest_severity[rid] }}{% endif %}">
        <div class="room-card-header">
          <div>
            <span class="room-card-name">{{ profile.resident_name }}</span>
            <span class="room-card-room">{{ rid }}</span>
          </div>
          <span class="mode-badge {% if profile.mode == 'memory_support' %}memory-support{% else %}standard{% endif %}">
            {% if profile.mode == 'memory_support' %}Memory{% else %}Standard{% endif %}
          </span>
        </div>
        <div class="room-card-stats">
          <div class="room-stat">
            <div class="room-stat-value">{{ room_help_counts[rid] }}</div>
            <div class="room-stat-label">Help (30m)</div>
          </div>
          <div class="room-stat">
            <div class="room-stat-value">{{ room_orientation_counts[rid] }}</div>
            <div class="room-stat-label">Orient. (7d)</div>
          </div>
          <div class="room-stat">
            <div class="room-stat-value">{{ room_active_alerts[rid] }}</div>
            <div class="room-stat-label">Active</div>
          </div>
          <div class="room-stat room-stat-actions">
            <a href="/room/{{ rid }}" class="room-link">View</a>
            <button type="button" class="room-edit-btn" onclick="openEditModal('{{ rid }}', '{{ profile.resident_name }}', '{{ profile.mode }}')">Edit</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </section>

    <!-- Filter Bar -->
    <form class="filter-bar" method="get" action="/staff">
      <label>Filters:</label>
      <select name="room_id" onchange="this.form.submit()">
        <option value="">All Rooms</option>
        {% for rid, profile in profiles.items() %}
        <option value="{{ rid }}" {% if filter_room == rid %}selected{% endif %}>{{ rid }} — {{ profile.resident_name }}</option>
        {% endfor %}
      </select>
      <select name="severity" onchange="this.form.submit()">
        <option value="">All Severities</option>
        <option value="emergency" {% if filter_severity == 'emergency' %}selected{% endif %}>Emergency</option>
        <option value="urgent" {% if filter_severity == 'urgent' %}selected{% endif %}>Urgent</option>
        <option value="routine" {% if filter_severity == 'routine' %}selected{% endif %}>Routine</option>
        <option value="informational" {% if filter_severity == 'informational' %}selected{% endif %}>Informational</option>
      </select>
      <select name="status" onchange="this.form.submit()">
        <option value="">All Statuses</option>
        <option value="new" {% if filter_status == 'new' %}selected{% endif %}>New</option>
        <option value="ack" {% if filter_status == 'ack' %}selected{% endif %}>Acknowledged</option>
        <option value="resolved" {% if filter_status == 'resolved' %}selected{% endif %}>Resolved</option>
      </select>
      {% if filter_room or filter_severity or filter_status %}
      <a href="/staff" class="filter-reset">Clear filters</a>
      {% endif %}
    </form>

    <!-- Alert Feed -->
    <section class="alert-feed">
      {% if alerts %}
        {% for alert in alerts %}
        <div class="alert-card status-{{ alert.status }}">
          <!-- Severity pill -->
          <div>
            <span class="severity-pill {{ alert.severity }}">
              <span class="severity-dot"></span>
              {{ alert.severity }}
            </span>
          </div>

          <!-- Content -->
          <div class="alert-content">
            <div class="alert-meta">
              <span class="alert-room">{{ alert.resident_name }} — Room {{ alert.room_id }}</span>
              <span class="alert-timestamp">{{ alert.created_at[:19] }}</span>
              <span class="alert-status {{ alert.status }}">{{ alert.status }}</span>
              {% if alert.mode == 'memory_support' %}
              <span class="mode-badge memory-support">Memory</span>
              {% endif %}
            </div>
            <div class="alert-message">{{ alert.message }}</div>

            <!-- Attribution & notes -->
            {% if alert.acknowledged_by %}
            <div class="alert-attribution">
              &#x2705; Ack'd by <strong>{{ alert.acknowledged_by }}</strong>
              {% if alert.acknowledged_at %}<span class="attr-time">{{ alert.acknowledged_at[:19] }}</span>{% endif %}
            </div>
            {% endif %}
            {% if alert.resolved_by %}
            <div class="alert-attribution resolved">
              &#x2714;&#xFE0F; Resolved by <strong>{{ alert.resolved_by }}</strong>
              {% if alert.resolved_at %}<span class="attr-time">{{ alert.resolved_at[:19] }}</span>{% endif %}
            </div>
            {% endif %}
            {% if alert.notes %}
            <div class="alert-notes">
              <span class="notes-label">Notes:</span> {{ alert.notes }}
            </div>
            {% endif %}
          </div>

          <!-- Actions with notes -->
          <div class="alert-actions">
            {% if alert.status == 'new' %}
            <button type="button" class="btn-action ack-btn" onclick="openNotesModal({{ alert.id }}, 'ack')">Acknowledge</button>
            {% endif %}
            {% if alert.status != 'resolved' %}
            <button type="button" class="btn-action resolve-btn" onclick="openNotesModal({{ alert.id }}, 'resolve')">Resolve</button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">&#x2705;</div>
          <p>No alerts to show. All is well.</p>
        </div>
      {% endif %}
    </section>

    <!-- Navigation -->
    <nav class="staff-nav">
      {% for rid, profile in profiles.items() %}
      <a href="/room/{{ rid }}">Room {{ rid }} ({{ profile.resident_name }})</a>
      {% endfor %}
    </nav>

  </div>

  <!-- Notes Modal (for ack/resolve) -->
  <div id="notes-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3 id="notes-modal-title">Add Notes</h3>
      <form id="notes-form" method="post">
        <input type="hidden" name="csrf" value="{{ csrf_token }}" />
        <textarea name="notes" id="notes-textarea" rows="3" placeholder="Optional notes about this alert..."></textarea>
        <div class="modal-actions">
          <button type="button" class="btn-action" onclick="closeNotesModal()">Cancel</button>
          <button type="submit" class="btn-action resolve-btn" id="notes-submit-btn">Confirm</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Room Modal -->
  <div id="edit-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3>Edit Room</h3>
      <form id="edit-form" method="post">
        <input type="hidden" name="csrf" value="{{ csrf_token }}" />
        <label for="edit-name">Resident Name</label>
        <input type="text" id="edit-name" name="resident_name" required />

        <label for="edit-mode">Care Mode</label>
        <select id="edit-mode" name="mode">
          <option value="standard">Standard</option>
          <option value="memory_support">Memory Support</option>
        </select>

        <div class="modal-actions">
          <button type="button" class="btn-action" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn-action ack-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Notes modal
    function openNotesModal(alertId, action) {
      const modal = document.getElementById('notes-modal');
      const form = document.getElementById('notes-form');
      const title = document.getElementById('notes-modal-title');
      const btn = document.getElementById('notes-submit-btn');
      const textarea = document.getElementById('notes-textarea');

      form.action = '/staff/alerts/' + alertId + '/' + action;
      title.textContent = action === 'ack' ? 'Acknowledge Alert' : 'Resolve Alert';
      btn.textContent = action === 'ack' ? 'Acknowledge' : 'Resolve';
      btn.className = 'btn-action ' + (action === 'ack' ? 'ack-btn' : 'resolve-btn');
      textarea.value = '';
      modal.style.display = 'flex';
      textarea.focus();
    }

    function closeNotesModal() {
      document.getElementById('notes-modal').style.display = 'none';
    }

    // Edit room modal
    function openEditModal(roomId, name, mode) {
      const modal = document.getElementById('edit-modal');
      const form = document.getElementById('edit-form');
      form.action = '/staff/rooms/' + roomId + '/edit';
      document.getElementById('edit-name').value = name;
      document.getElementById('edit-mode').value = mode;
      modal.style.display = 'flex';
      document.getElementById('edit-name').focus();
    }

    function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.style.display = 'none';
        }
      });
    });

    // Close modals on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay').forEach(function(m) {
          m.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>
